<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²¬ì ì„œ ì¡°íšŒ</title>
    <link rel="stylesheet" href="../shared/css/style.css">
    <style>
        @media print {
            body { 
                background: white !important; 
                -webkit-print-color-adjust: exact;
            }
            .no-print { display: none !important; }
            .print-container {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 20px !important;
            }
            @page {
                size: A4;
                margin: 10mm;
            }
        }
        
        .quote-document {
            max-width: 21cm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .company-header {
            text-align: center;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .company-name {
            font-size: 28px;
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 5px;
        }
        
        .document-title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #374151;
        }
        
        .quote-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }
        
        .info-section h4 {
            background: #f3f4f6;
            padding: 8px 12px;
            margin: 0 0 15px 0;
            font-weight: bold;
            border-left: 4px solid #3b82f6;
        }
        
        .info-item {
            display: flex;
            margin-bottom: 8px;
        }
        
        .info-label {
            min-width: 120px;
            font-weight: 500;
            color: #6b7280;
        }
        
        .info-value {
            color: #374151;
        }
        
        .quote-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 13px;
        }
        
        .quote-table th {
            background: #3b82f6;
            color: white;
            padding: 8px 4px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
        }
        
        .quote-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #e5e7eb;
            text-align: center;
            font-size: 12px;
            white-space: nowrap;
        }
        
        .quote-table .text-left { text-align: left; }
        .quote-table .text-right { text-align: right; }
        
        .quote-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .total-row {
            background: #f8fafc !important;
            font-weight: bold;
            font-size: 16px;
        }
        
        .total-amount {
            color: #dc2626;
            font-size: 18px;
            font-weight: bold;
        }
        
        .quote-notes {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .quote-notes h4 {
            margin: 0 0 10px 0;
            color: #374151;
        }
        
        .quote-notes ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .quote-notes li {
            margin-bottom: 5px;
            color: #6b7280;
        }
        
        .action-buttons {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 0 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .loading {
            text-align: center;
            padding: 100px 20px;
            color: #6b7280;
        }
        
        .error {
            text-align: center;
            padding: 100px 20px;
            color: #dc2626;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        
        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingState" class="loading">
            <h2>ê²¬ì ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h2>
            <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
        </div>
        
        <!-- ì—ëŸ¬ ìƒíƒœ -->
        <div id="errorState" class="error hidden">
            <h2>ê²¬ì ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
            <p>ë§í¬ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ ê²¬ì ì„œê°€ ë§Œë£Œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <a href="../coirmat/" class="btn btn-primary">ìƒˆ ê²¬ì  ì‘ì„±í•˜ê¸°</a>
        </div>
        
        <!-- ê²¬ì ì„œ ë¬¸ì„œ -->
        <div id="quoteDocument" class="quote-document hidden print-container">
            
            <!-- íšŒì‚¬ í—¤ë” -->
            <div class="company-header">
                <div class="company-name">ë‘ë°œë¡œãˆœ</div>
                <div style="color: #6b7280; font-size: 14px;">
                    TEL: 031-866-8872 | EMAIL: quitesotrue@gmail.com
                </div>
            </div>
            
            <!-- ë¬¸ì„œ ì œëª© -->
            <div class="document-title">ê²¬ ì  ì„œ</div>
            
            <!-- ê²¬ì  ì •ë³´ -->
            <div class="quote-info">
                <div class="info-section">
                    <h4>ê²¬ì  ìš”ì²­ì</h4>
                    <div class="info-item">
                        <span class="info-label">ê³ ê°ëª…:</span>
                        <span class="info-value" id="customerName">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì—°ë½ì²˜:</span>
                        <span class="info-value" id="customerPhone">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì´ë©”ì¼:</span>
                        <span class="info-value" id="customerEmail">-</span>
                    </div>
                </div>
                
                <div class="info-section">
                    <h4>ê³µê¸‰ì</h4>
                    <div class="info-item">
                        <span class="info-label">íšŒì‚¬ëª…:</span>
                        <span class="info-value">ë‘ë°œë¡œãˆœ</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ëŒ€í‘œì:</span>
                        <span class="info-value">ë°•ëŒ€ê·¼</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸:</span>
                        <span class="info-value">769-86-01460</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì†Œì¬ì§€:</span>
                        <span class="info-value">ê²½ê¸°ë„ ì–‘ì£¼ì‹œ ê´‘ì ë©´ ê´‘ì ë¡œ 221-8</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì—°ë½ì²˜:</span>
                        <span class="info-value">031-866-8872</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ê²¬ì ì¼:</span>
                        <span class="info-value" id="quoteDate">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ìœ íš¨ê¸°ê°„:</span>
                        <span class="info-value" id="expiryDate">-</span>
                    </div>
                </div>
            </div>
            
            <!-- ê²¬ì  í…Œì´ë¸” -->
            <table class="quote-table">
                <thead>
                    <tr>
                        <th style="width: 28%">í’ˆëª©</th>
                        <th style="width: 15%">ë¬¼í’ˆì‹ë³„ë²ˆí˜¸</th>
                        <th style="width: 18%">ê·œê²©</th>
                        <th style="width: 13%">ë‹¨ê°€</th>
                        <th style="width: 8%">ìˆ˜ëŸ‰</th>
                        <th style="width: 18%">ê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody id="quoteItems">
                    <!-- ê²¬ì  í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="5" class="text-right">ì´ ê²¬ì  ê¸ˆì•¡</td>
                        <td class="text-right total-amount" id="totalAmount">-</td>
                    </tr>
                </tfoot>
            </table>
            
            <!-- ê²¬ì  ì¡°ê±´ -->
            <div class="quote-notes">
                <h4>ê²¬ì  ì¡°ê±´</h4>
                <ul>
                    <li>ìƒê¸° ê²¬ì  ê¸ˆì•¡ì—ëŠ” ë¶€ê°€ì„¸ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
                    <li>ì¸ë„ì¡°ê±´: ë‚©í’ˆì¥ì†Œ í•˜ì°¨ë„</li>
                    <li>ê²¬ì  ìœ íš¨ê¸°ê°„: <span id="expiryDateNote">-</span>ê¹Œì§€</li>
                    <li>ê²°ì œì¡°ê±´: ë³„ë„ í˜‘ì˜</li>
                    <li>ê¸°íƒ€ ë¬¸ì˜ì‚¬í•­ì€ ì–¸ì œë“ ì§€ ì—°ë½ ë°”ëë‹ˆë‹¤.</li>
                </ul>
            </div>
            
            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
            <div class="action-buttons no-print">
                <button onclick="window.print()" class="btn btn-primary">
                    ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°
                </button>
                <button onclick="downloadPDF()" class="btn btn-secondary">
                    ğŸ“„ PDF ì €ì¥
                </button>
                <a href="../coirmat/" class="btn btn-secondary">
                    âœï¸ ìƒˆ ê²¬ì  ì‘ì„±
                </a>
            </div>
        </div>
    </div>

    <script>
        // URLì—ì„œ ê²¬ì  ID ì¶”ì¶œ
        function getQuoteId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        
        // ê²¬ì  ë°ì´í„° ë¡œë“œ (JSONP ë°©ì‹ìœ¼ë¡œ CORS ìš°íšŒ)
        function loadQuoteData() {
            const quoteId = getQuoteId();
            
            if (!quoteId) {
                showError();
                return;
            }
            
            try {
                // JSONP ë°©ì‹ìœ¼ë¡œ CORS ìš°íšŒ
                const script = document.createElement('script');
                const callbackName = 'quoteCallback_' + Date.now();
                
                // ì „ì—­ ì½œë°± í•¨ìˆ˜ ìƒì„±
                window[callbackName] = function(data) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    
                    if (data.success) {
                        displayQuote(data.quote);
                    } else {
                        console.error('Error:', data.error);
                        showError();
                    }
                };
                
                // ì—ëŸ¬ ì²˜ë¦¬
                script.onerror = function() {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    console.error('Script loading failed');
                    showError();
                };
                
                // íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ (10ì´ˆ í›„ ì—ëŸ¬)
                setTimeout(function() {
                    if (window[callbackName]) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        console.error('Request timeout');
                        showError();
                    }
                }, 10000);
                
                script.src = `https://script.google.com/macros/s/AKfycbzvx-J3VntBiniVB5VB_wk1u5qzNDh1mqzMZ9mBhndgsEhUdiSH0XUgzhTzGOrjsTXOzw/exec?action=getQuote&id=${quoteId}&callback=${callbackName}`;
                document.head.appendChild(script);
                
            } catch (error) {
                console.error('Error loading quote:', error);
                showError();
            }
        }
        
        // ê²¬ì ì„œ í‘œì‹œ
        function displayQuote(quote) {
            // ë¡œë”© ìˆ¨ê¸°ê³  ê²¬ì ì„œ í‘œì‹œ
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('quoteDocument').classList.remove('hidden');
            
            // ê³ ê° ì •ë³´
            document.getElementById('customerName').textContent = quote.customerName;
            document.getElementById('customerPhone').textContent = quote.phone;
            document.getElementById('customerEmail').textContent = quote.email;
            
            // ë‚ ì§œ ì •ë³´
            const quoteDate = new Date(quote.timestamp);
            document.getElementById('quoteDate').textContent = quoteDate.toLocaleDateString('ko-KR');
            
            const expiryDate = new Date(quoteDate);
            expiryDate.setMonth(expiryDate.getMonth() + 1);
            const expiryStr = expiryDate.toLocaleDateString('ko-KR');
            document.getElementById('expiryDate').textContent = expiryStr;
            document.getElementById('expiryDateNote').textContent = expiryStr;
            
            // ê²¬ì  í•­ëª©ë“¤
            const quoteItems = document.getElementById('quoteItems');
            quoteItems.innerHTML = '';
            
            quote.items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-left">${item.name}</td>
                    <td>${item.code}</td>
                    <td>${item.spec}</td>
                    <td class="text-right">${formatCurrency(item.unitPrice)}ì›</td>
                    <td class="text-right">${item.quantity}</td>
                    <td class="text-right">${formatCurrency(item.amount)}ì›</td>
                `;
                quoteItems.appendChild(row);
            });
            
            // ì´ì•¡
            document.getElementById('totalAmount').textContent = formatCurrency(quote.totalAmount) + 'ì›';
        }
        
        // ì—ëŸ¬ í‘œì‹œ
        function showError() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }
        
        // ê¸ˆì•¡ í¬ë§·íŒ…
        function formatCurrency(amount) {
            return parseInt(amount).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // PDF ì €ì¥
        function downloadPDF() {
            window.print();
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê²¬ì  ë°ì´í„° ë¡œë“œ
        document.addEventListener('DOMContentLoaded', loadQuoteData);
    </script>
</body>
</html>
